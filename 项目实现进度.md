# 项目实施与进度文档

更新时间：2026-02-25（同步修订）

本文件作为当前项目的唯一实施文档，替代原规划文档。

## 1. 当前结论

- 项目已具备可用 MVP，支持登录、上游管理、手动节点、同步、固定输出、JSON/SQLite 备份导出与恢复。
- 已完成“主机 sing-box 脚本 + Docker SubAdmin”共存优化（默认不占 80/443）。
- 已完成“快照回滚 + 多 token 访问控制”增强能力，当前主要待办集中在高级同步策略。
- 已完成同步链路稳定性修复：请求超时可配置、SQLite 同步阻塞修复、`414 URI Too Long` 修复。
- 已完成同步结果语义修正：上游不是 URI/base64 节点订阅时会明确失败，不再出现“假成功”。

## 2. 项目目标对照

- ~~网页管理员后台~~
- ~~管理上游订阅源~~
- ~~管理手动节点~~
- ~~定时自动同步~~
- ~~自动生成 Clash / Sing-box 订阅~~
- ~~固定订阅 URL~~
- ~~支持备份恢复（JSON）~~
- ~~Docker Compose 一键部署~~
- ~~自动 HTTPS（Caddy，可选网关模式）~~

## 3. 核心功能模块对照

### A. 管理后台

- ~~管理员登录~~
- ~~修改密码~~
- ~~CRUD 上游订阅源~~
- ~~CRUD 手动节点~~
- ~~同步状态查看~~
- ~~手动触发同步~~
- ~~设置同步频率~~
- ~~导出 / 导入（JSON）~~
- ~~查看系统日志~~
- ~~原始订阅内容预览 / 粘贴编辑（URI/base64）~~

### B. 上游订阅同步模块

- ~~支持多个上游订阅源~~
- ~~启用/禁用~~
- ~~同步间隔（分钟）~~
- ~~定时任务自动执行~~
- ~~手动触发~~
- 去重策略（已实现基础去重）
- 覆盖策略（未完成）
- 合并策略（未完成）
- 同步失败记录日志（已实现系统日志与同步任务明细）

### C. 订阅输出模块

- ~~固定地址 `/clash`、`/singbox`~~
- ~~聚合启用上游 + 手动节点~~
- ~~拼接 config 字符串并输出~~
- ~~支持实时输出~~
- ~~支持缓存模式输出~~
- ~~调用 `sublink-worker` 官方接口完全对齐（已去掉 fallback 模式）~~

### D. 备份模块

- ~~导出 SQLite 数据库文件~~
- ~~导出 JSON~~
- ~~自动定期备份~~
- ~~手动导入恢复~~
- ~~保留历史版本（snapshots）~~
- ~~快照回滚（clash/singbox）~~

### E. 访问控制模块

- ~~多 token 会话管理（新增/查看/吊销）~~
- ~~Token 会话校验（启用状态 + 过期时间）~~
- ~~改密后自动吊销其他 token~~

## 4. API 对照

已完成（含计划内接口）：

- ~~`POST /api/login`~~
- ~~`POST /api/logout`~~
- ~~`GET /api/me`~~
- ~~`GET /api/upstreams`~~
- ~~`POST /api/upstreams`~~
- ~~`PUT /api/upstreams/:id`~~
- ~~`DELETE /api/upstreams/:id`~~
- ~~`POST /api/upstreams/:id/sync`~~
- ~~`GET /api/upstreams/:id/raw`~~
- ~~`POST /api/upstreams/:id/raw/preview`~~
- ~~`PUT /api/upstreams/:id/raw`~~
- ~~`GET /api/nodes`~~
- ~~`POST /api/nodes`~~
- ~~`PUT /api/nodes/:id`~~
- ~~`DELETE /api/nodes/:id`~~
- ~~`GET /clash`~~
- ~~`GET /singbox`~~
- ~~`GET /api/backup/export`~~
- ~~`GET /api/backup/sqlite`~~
- ~~`POST /api/backup/import`~~
- ~~`GET /api/snapshots`~~
- ~~`POST /api/snapshots/:id/rollback`~~
- ~~`GET /api/tokens`~~
- ~~`POST /api/tokens`~~
- ~~`DELETE /api/tokens/:id`~~

已扩展（计划外增强）：

- `PUT /api/password`
- `POST /api/sync`
- `GET /api/settings`
- `PUT /api/settings`
- `GET /api/logs/sync`
- `GET /api/logs/system`
- `GET /healthz`

## 5. 已完善优化（本轮）

- ~~支持“主机 sing-box 脚本 + Docker SubAdmin”共存部署~~
- ~~默认不抢占 80/443（Caddy 改为可选 profile）~~
- ~~API/Web 默认高位端口（18080/18081）~~
- ~~`host.docker.internal` 打通（容器访问主机服务）~~
- ~~Web 内置反代 API（不开 Caddy 也可直接使用）~~
- ~~补充共存模式部署文档~~
- ~~修复手动全量同步超时导致的 `context deadline exceeded`（API/调度超时改为可配置）~~
- ~~修复 SQLite 单连接场景下同步流程可能阻塞的问题（改为先收集上游 ID 再逐个同步）~~
- ~~修复大订阅转换触发 `414 URI Too Long`（新增临时中转源 URL 模式）~~
- ~~新增 `SUBLINK_SOURCE_BASE_URL` 配置，明确 `sublink` 拉取中转源地址~~
- ~~同步结果改进：非节点格式上游（如完整 YAML 配置）明确报 `subscription contains no nodes`~~

## 6. 运行与验收补充信息

### 6.1 推荐运行模式

- 共存模式（推荐）：`docker compose up -d --build api web sublink`
- 网关模式（可选）：`docker compose --profile gateway up -d --build`

### 6.2 本地/服务器验收清单

- `http://<host>:18081/healthz` 返回 `{"status":"ok"}`
- `POST /api/login` 可成功拿到 token
- 新增手动节点后访问 `/clash` 有输出
- 新增上游后手动同步：
  - 上游为有效 URI/base64 节点订阅时，状态显示 `ok (...)`
  - 上游为完整 `yaml/json` 配置地址时，状态显示 `sync failed: subscription contains no nodes`
- `GET /api/backup/sqlite` 可下载 `.db` 文件
- 开启自动备份后在 `data/backups/` 目录可看到按策略生成的 `.json` / `.db` 文件

### 6.3 上游地址注意

- 容器内不能用 `127.0.0.1` 或 `localhost` 访问主机服务。
- 应使用主机域名 URL，或 `host.docker.internal:<port>`。

### 6.4 手动节点含义

- 当前“手动节点”是单条 URI（如 `ss://`、`vmess://`），不是整份 `yaml/json` 配置编辑器。

### 6.5 同步排障建议（已验证）

- 出现 `query upstream ... context deadline exceeded`：
  - 检查是否已部署本轮修复版本。
  - 检查 `API_TIMEOUT_SECONDS` / `SCHEDULER_JOB_TIMEOUT_SECONDS` 是否设置过小。
- 出现 `convert endpoint status 414`：
  - 检查是否已部署本轮修复版本。
  - 检查 `SUBLINK_SOURCE_BASE_URL` 是否可被 `sublink` 容器访问。
- 出现 `subscription contains no nodes`：
  - 说明上游内容不是 URI/base64 节点订阅（常见为 `clash.yaml`/`singbox.json` 配置地址）。
  - 应替换为节点订阅链接，或使用原始订阅内容粘贴（URI/base64）。
- 出现 `no nodes available for conversion`：
  - 说明当前启用的上游与手动节点汇总后无可识别节点。
  - 建议结合 `GET /api/logs/sync` 与 `GET /api/logs/system` 逐条定位。

## 7. 关键待办（建议优先级）

1. 同步策略增强：覆盖策略与合并策略（包含可视化配置与冲突处理）。

## 8. 变更记录（Changelog）

### 2026-02-25

- 初始化项目骨架：`backend`、`web`、`docker-compose`、`caddy`。
- 完成后端 API：认证、上游 CRUD、节点 CRUD、同步、设置、订阅输出、JSON 备份导入导出。
- 完成前端管理界面：登录、上游管理、手动节点管理、系统设置、备份恢复。
- 完成容器化部署：`api/web/sublink/caddy` 多服务编排。
- 修复运行问题：Caddy 路由匹配、API 容器 SQLite 写权限、前端构建语法错误。
- 完成共存模式优化：默认高位端口、可选 Caddy profile、`host.docker.internal` 可访问主机服务、Web 内置 API 反代。
- 新增系统日志能力：后端 `system_logs/sync_logs`、日志查询 API、前端日志页面与同步任务明细。
- 对齐转换接口：改为官方 `/sub` API，并移除 fallback 输出模式（转换失败将显式报错）。
- 新增上游原始订阅编辑：支持 URI/base64 预览与写入缓存（`/api/upstreams/:id/raw*`）。
- 新增备份增强：自动定期备份（JSON + SQLite）、SQLite 手动导出接口与前端入口。
- 新增访问控制增强：多 token 管理（创建、列表、吊销）、鉴权时会话状态校验、改密后吊销其他 token。
- 新增快照回滚能力：快照列表查询、按快照回滚 clash/singbox 输出缓存、回滚写入系统日志与回滚快照记录。
- 将项目文档统一为本文件，移除旧规划文档。
- 修复同步稳定性：API 超时/调度超时可配置，修复单连接 SQLite 下同步流程可能阻塞导致的超时。
- 修复转换链路：引入临时中转源 URL，解决大订阅触发 `414 URI Too Long`。
- 同步结果语义修正：仅识别节点 URI 协议行，非节点格式上游会明确失败并给出可操作错误信息。

## 9. 上线检查清单（Production Checklist）

上线前建议逐项确认：

1. 修改 `.env` 中 `JWT_SECRET`、`ADMIN_PASSWORD` 为强随机值。
2. 如使用网关模式，确认 `DOMAIN`、DNS、证书签发与续期正常。
3. 如使用共存模式，确认防火墙仅开放必要端口（默认 `18081`，按需开放 `18080`）。
4. 上游订阅地址全部可从容器访问，不使用 `127.0.0.1/localhost`。
5. 至少配置一个有效上游并执行一次手动同步，检查状态为 `ok (...)`。
6. 校验固定输出：`/clash`、`/singbox` 返回内容符合预期客户端。
7. 验证管理员登录、改密、退出流程。
8. 导出一次 JSON 与 SQLite 备份，并在测试环境完成导入恢复演练。
9. 配置日志采集策略（至少保留容器日志和关键操作时间点）。
10. 如启用自动备份，确认备份间隔和保留份数与磁盘容量匹配。
11. 制定回滚方案：保留最近可用镜像与数据目录快照。
