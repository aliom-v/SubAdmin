# 项目实施与进度文档

更新时间：2026-02-25（结构化修订）

## 1. 文档定位

- 本文档用于记录当前可用能力、已完成修复、验收口径和后续待办。
- 目标是让开发、运维和验收都可以基于同一份事实执行。

## 2. 当前结论

- 项目已具备可用 MVP，并已完成多轮稳定性修复。
- 已支持共存部署（默认不占用 80/443），可通过 Docker Compose 直接运行。
- 当前主要待办聚焦在“高级同步策略”（覆盖/合并）而非基础可用性。

## 3. 功能状态矩阵

| 模块 | 状态 | 说明 |
|---|---|---|
| 管理后台 | 已完成 | 登录、改密、上游/节点 CRUD、同步触发、设置、日志查询 |
| 认证与会话 | 已完成 | 多 Token 会话管理、吊销、过期校验、改密后吊销其他 Token |
| 上游同步 | 已完成（基础） | 支持多上游、启停、同步间隔、手动+定时同步、同步日志 |
| 订阅输出 | 已完成 | 固定输出 `/clash` `/singbox`，支持缓存模式与实时模式 |
| 转换链路 | 已完成 | 对齐 `subconverter /sub`，已修复大订阅 `414 URI Too Long` |
| 备份恢复 | 已完成 | JSON 导出/导入、SQLite 导出、自动备份、快照回滚 |
| 日志审计 | 已完成 | `sync_logs` 与 `system_logs`，含 API 查询能力 |
| 高级同步策略 | 未完成 | 覆盖策略、合并策略、冲突处理规则 |

## 4. 已实现 API 范围

认证与会话：

- `POST /api/login`
- `POST /api/logout`
- `GET /api/me`
- `PUT /api/password`
- `GET /api/tokens`
- `POST /api/tokens`
- `DELETE /api/tokens/:id`

上游管理与同步：

- `GET /api/upstreams`
- `POST /api/upstreams`
- `PUT /api/upstreams/:id`
- `DELETE /api/upstreams/:id`
- `POST /api/upstreams/:id/sync`
- `GET /api/upstreams/:id/raw`
- `POST /api/upstreams/:id/raw/preview`
- `PUT /api/upstreams/:id/raw`
- `POST /api/sync`

手动节点：

- `GET /api/nodes`
- `POST /api/nodes`
- `PUT /api/nodes/:id`
- `DELETE /api/nodes/:id`

系统设置与日志：

- `GET /api/settings`
- `PUT /api/settings`
- `GET /api/logs/sync`
- `GET /api/logs/system`

备份与快照：

- `GET /api/backup/export`
- `GET /api/backup/sqlite`
- `POST /api/backup/import`
- `GET /api/snapshots`
- `POST /api/snapshots/:id/rollback`

固定输出与健康检查：

- `GET /clash`
- `GET /singbox`
- `GET /healthz`

## 5. 部署模式与关键配置

推荐运行模式：

- 共存模式（推荐）：`docker compose up -d --build api web sublink`
- 网关模式（可选）：`docker compose --profile gateway up -d --build`

关键环境变量（同步相关）：

- `API_TIMEOUT_SECONDS`：API 请求超时（默认 300 秒）
- `SCHEDULER_JOB_TIMEOUT_SECONDS`：定时任务单次执行超时（默认 300 秒）
- `HTTP_TIMEOUT_SECONDS`：单个上游 HTTP 拉取超时（默认 20 秒）
- `SUBLINK_SOURCE_BASE_URL`：供 `sublink` 拉取临时中转源的 API 地址（Docker 默认 `http://api:8080`）

## 6. 同步链路现状（重点）

当前同步主流程：

1. 读取启用上游并触发拉取。
2. 解析上游内容为节点 URI（并去重）。
3. 写回上游缓存与同步状态。
4. 聚合节点后调用 `subconverter` 生成 Clash/Sing-box 输出。
5. 缓存模式下写入本地缓存文件并生成快照。

本轮关键修复（已落地）：

- 修复 `context deadline exceeded`：
  - API 超时和调度任务超时改为可配置。
- 修复 SQLite 单连接下同步阻塞：
  - 改为先收集上游 ID，再逐个同步，避免 `rows` 占用期间嵌套查询。
- 修复 `convert endpoint status 414`：
  - 增加临时中转源 URL，不再把大 payload 直接放进 query。
- 修复“假成功同步”：
  - 仅识别合法节点 URI 协议行，非节点格式内容会明确失败。

当前错误语义（用于排障）：

- `query upstream ... context deadline exceeded`：通常是旧版本或超时参数过小。
- `convert endpoint status 414`：通常是旧版本未使用中转源。
- `subscription contains no nodes`：上游不是 URI/base64 节点订阅（常见是 YAML/JSON 完整配置地址）。
- `no nodes available for conversion`：启用上游与手动节点聚合后无可识别节点。

## 7. 验收清单（建议）

基础可用性：

- `GET /healthz` 返回 `{"status":"ok"}`。
- `POST /api/login` 可返回 token。
- 新增一个手动 URI 节点后，`/clash` 可成功输出。

同步链路：

- 有效 URI/base64 上游同步后，`last_status` 显示 `ok (...)`。
- 非节点格式上游（如完整 YAML/JSON 配置）同步后，`last_status` 明确失败为 `subscription contains no nodes`。

备份与回滚：

- `GET /api/backup/export` 可导出 JSON。
- `GET /api/backup/sqlite` 可下载 `.db`。
- 快照回滚后，输出缓存和系统日志可见对应记录。

## 8. 已知边界与限制

- 当前上游输入期望为 URI/base64 节点订阅，不是完整配置文件编辑器。
- 高级同步策略（覆盖/合并）尚未完成。
- 本地无 Go/NPM 时，建议通过 Docker 构建验证。

## 9. 下一阶段计划

P0（优先）：

1. 设计并实现覆盖策略/合并策略（含冲突处理规则）。
2. 在前端补充策略配置入口和结果解释信息。

P1（增强）：

1. 增强上游格式兼容（按需评估 YAML 节点提取能力）。
2. 增加更细粒度的同步统计与失败分类。

## 10. 变更记录（摘要）

### 2026-02-25

- 完成基础系统：认证、上游/节点管理、同步、固定输出、备份恢复、容器化部署。
- 完成增强能力：系统日志与同步日志、多 Token、自动备份、快照回滚。
- 完成稳定性修复：同步超时配置化、SQLite 同步阻塞修复、`414 URI Too Long` 修复、同步语义修正。
- 完成文档整理：`README` 去重并聚焦用途，新增 `docs/TROUBLESHOOTING.md` 与 `docs/BACKUP_RESTORE.md`。
- 完成安全增强：服务启动时对弱 `ADMIN_PASSWORD` / `JWT_SECRET` 输出告警（不阻断启动）。
